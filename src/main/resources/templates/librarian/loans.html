<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Librarian - Loans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { font-size: 14px; }
    </style>
</head>
<body>
    <div th:replace="librarian/fragments/navbar :: navbar"></div>

    <main class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h3"><i class="bi bi-clock-history me-2"></i>Library Loans</h1>
                <p class="text-muted">Active loans in your library</p>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Resource</th>
                                <th>Client</th>
                                <th>Status</th>
                                <th>Reserved At</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                                          <tbody>
                            <th:block th:each="loan, stat : ${loans}">
                                
                                <!-- 1. Vérification du changement de groupe -->
                                <!-- On vérifie si c'est le premier élément (stat.index == 0) OU si le titre de la ressource actuelle est différent de celui de la ressource précédente -->
                                <th:block th:if="${stat.index == 0 or loan.resource.title != loans[stat.index - 1].resource.title}">
                                    <!-- En-tête de groupe (s'affiche uniquement si le titre a changé) -->
                                    <tr class="table-primary">
                                        <!-- Colspan 7 pour couvrir toutes les colonnes -->
                                        <td colspan="7" class="fw-bold h5" th:text="${loan.resource.title}">Titre de la Ressource</td>
                                    </tr>
                                </th:block>
                                
                                <!-- 2. Ligne de détail du prêt -->
                                <tr>
                                    <td th:text="${loan.id}">1</td>
                                    <td th:text="${loan.resource.title}">Resource</td>
                                    <td th:text="${loan.client.username}">client</td>
                                    <td th:text="${loan.status}">Status</td>
                                    <td th:text="${loan.reservationDate != null ? #temporals.format(loan.reservationDate, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                    <td th:text="${loan.dueDate != null ? #temporals.format(loan.dueDate, 'yyyy-MM-dd') : '-'}">-</td>
                                    <td>
                                        <form th:action="@{/librarian/loans/{id}/borrow(id=${loan.id})}" method="post" th:if="${loan.status.name() == 'RESERVED'}" style="display:inline-block">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <button class="btn btn-sm btn-primary" type="submit" onclick="return confirm('Mark this reserved resource as borrowed?')">Borrow</button>
                                        </form>
                                        <form th:action="@{/librarian/loans/{id}/return(id=${loan.id})}" method="post" th:if="${loan.status.name() == 'IN_PROGRESS'}" style="display:inline-block">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <button class="btn btn-sm btn-success" type="submit" onclick="return confirm('Mark this resource as returned?')">Return</button>
                                        </form>
                                    </td>
                                </tr>
                            </th:block>
                        </tbody>

                    </table>
                </div>

                <div th:if="${#lists.isEmpty(loans)}" class="text-center py-5 text-muted">
                    <i class="bi bi-check2-circle display-1"></i>
                    <h4 class="mt-3">No active loans</h4>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="fragments/client-footer :: footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
