<div th:fragment="notifications">
    <ul class="list-group position-relative"
        id="notificationList"
        style="z-index: 1050;">
        <!-- Notifications will be appended here -->
    </ul>

    <!-- WebSocket libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script th:inline="javascript">
    /*<![CDATA[*/

    let unreadCount = 0;

    // Native sound (no imports, no files)
    function playNotificationSound() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = "sine";
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
        } catch (e) {
            console.warn("Audio blocked until user interaction");
        }
    }

    // WebSocket setup
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, function () {
        console.log('WebSocket connected');

        stompClient.subscribe('/user/queue/notifications', function (message) {
            const notification = JSON.parse(message.body);
            addNotification(notification);
        });
    }, function (error) {
        console.error('WebSocket connection error:', error);
    });

    // Load existing notifications
    fetch('/api/notifications')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load notifications');
            }
            return response.json();
        })
        .then(notifications => {
            notifications.forEach(addNotification);
        })
        .catch(err => console.warn(err.message));

    // Render notification
    function addNotification(notification) {
        const list = document.getElementById('notificationList');
        if (!list) return;

        const item = document.createElement('li');
        item.className = 'list-group-item d-flex justify-content-between align-items-start';

        item.innerHTML = `
            <div>
                <strong>${notification.type}</strong><br/>
                <small>${notification.message}</small>
            </div>
        `;

        list.prepend(item);

        // ðŸ”´ Badge
        unreadCount++;
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.textContent = unreadCount;
            badge.classList.remove('d-none');
        }

        // ðŸ”” Animation
        const bell = document.querySelector('.bi-bell');
        if (bell) {
            bell.classList.add('bell-animate');
            setTimeout(() => bell.classList.remove('bell-animate'), 600);
        }

        // ðŸ”Š Sound
        playNotificationSound();
    }

    // Clear badge when dropdown opens (UX only)
    document.addEventListener('click', function (e) {
        if (e.target.closest('[data-bs-toggle="dropdown"]')) {
            unreadCount = 0;
            const badge = document.getElementById('notificationBadge');
            if (badge) badge.classList.add('d-none');
        }
    });

    /*]]>*/
    </script>
</div>
